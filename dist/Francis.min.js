"use strict";function _classCallCheck(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,n){for(var e=0;e<n.length;e++){var a=n[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(n,e,a){return e&&t(n.prototype,e),a&&t(n,a),n}}(),Francis=function(){function t(n){_classCallCheck(this,t);var e=this;e.status=t.QUERIER_STATUS.IDLE,e.workQueue=[],e.readyTransactions=[],e.workingRequests=[],e.currentTransaction="",e.logger=n.logger||console,e.mode=n.mode||t.QUERIER_MODE.PARALLEL,e.uniqueTransactions=n.uniqueTransactions||!0,e.transactions={}}return _createClass(t,[{key:"abortAll",value:function(){var n=this;n.status=t.QUERIER_STATUS.ABORTING;for(var e in n.transactions)n.transactions.hasOwnProperty(e)&&n.abortTransaction(e);return n.status=t.QUERIER_STATUS.IDLE,n}},{key:"removeTransaction",value:function(t){var n=this;return n._removeTransaction(t),n}},{key:"abortTransaction",value:function(t){var n=this;return n._abortTransaction(t),n}},{key:"query",value:function(t,n,e){var a=this;return a._addActionToTransaction(t,n),a}},{key:"createTransaction",value:function(t,n){var e=this;return e.transactions.hasOwnProperty(t)?e.uniqueTransactions&&(e._removeTransaction(t),e._createTransaction(t)):e._createTransaction(t),n&&e._setTransactionOptions(e.transactions[t],n),e}},{key:"startAll",value:function(){var t=this;return t}},{key:"startTransaction",value:function(t){var n=this;return n}},{key:"stopAll",value:function(){var t=this;return t}},{key:"stop",value:function(t){var n=this;return n}},{key:"_setTransactionOptions",value:function(t,n){return t.mode=n.mode||t.mode,t.transactionError=n.transactionError||t.transactionError,t.finalize=n.finalize||t.finalize,t}},{key:"_createTransaction",value:function(n){var e=this;e.transactions[n]={name:n,context:{},actions:[],status:t.QUERIER_STATUS.IDLE,mode:t.QUERIER_MODE.SINGLE,failedCount:0,successCount:0,ended:!1,transactionError:function(){e.logger.log("oops, something went wrong :(")},finalize:function(){e.logger.log("yay, it worked :)")}},e.transactions[n].context.transactionId="something"}},{key:"_removeTransaction",value:function(t){var n=this;n._abortTransaction(t),delete n.transactions[t]}},{key:"_abortTransaction",value:function(n){var e=this,a=e.transactions[n];if(a.status===t.QUERIER_STATUS.ABORTING)return!1;var r=a.context.transactionId;a.status=t.QUERIER_STATUS.ABORTING;for(var o=0;o<e.workingRequests.length;o++){var s=e.workingRequests[o];s.transactionId===r&&s.xhr.abort()}e.logger.log("Transaction ["+a.name+"] aborted successfully. "+requestsToAbort.length+" related requests canceled.")}},{key:"_addActionToTransaction",value:function(t,n){var e=this,a=e.transactions[t],r="something",o=n.success;n.success=function(){a.successCount++,e._removeItemFromWorkQueue(r),e._requestDone(a),o&&"function"==typeof o&&o()};var s=n.error;n.error=function(){a.failedCount++,e._removeItemFromWorkQueue(r),e._requestDone(a),s&&"function"==typeof s&&s()},a.actions.push({transactionName:t,transactionId:a.context.transactionId,requestId:r,ajaxObject:n})}},{key:"_performActualQuery",value:function(t){var n=this;n.currentTransaction=t.transactionName,n.workingRequests.push({transactionName:t.transactionName,transactionId:t.transactionId,requestId:t.requestId,xhr:$.ajax(t.ajaxObject)})}},{key:"_removeItemFromWorkQueue",value:function(t){for(var n=this,e=0;e<n.workingRequests.length;e++){var a=n.workingRequests[e];if(a.requestId===t)return n.workingRequests.splice(e,1),!0}return!1}},{key:"_requestDone",value:function(n){var e=this;n.actions.length?n.status!==t.QUERIER_STATUS.READY&&e.status===t.QUERIER_STATUS.LOCKED||e.mode===t.QUERIER_MODE.SINGLE&&e.currentTransaction!==n.name?(e.readyTransactions.push(n.name),n.status=t.QUERIER_STATUS.READY):n.status===t.QUERIER_STATUS.LOCKED||n.status===t.QUERIER_STATUS.ABORTING||n.mode===t.QUERIER_MODE.SINGLE&&e.workQueue.push(n.actions.shift()):n.ended&&n.finalize(),e._doWork()}},{key:"_doWork",value:function(){var n=this;if(n.workQueue.length&&(n.status===t.QUERIER_STATUS.IDLE||n.status===t.QUERIER_STATUS.WORKING)){var e=n.workQueue.shift();n._performActualQuery(e)}}}],[{key:"QUERIER_STATUS",get:function(){return{IDLE:1,WORKING:2,AWAITING_RESPONSE:3,HANDLING_RESPONSE:4,ERROR:5,LOCKED:6,ABORTING:7,READY:8,CLEANUP:9}}},{key:"QUERIER_MODE",get:function(){return{PARALLEL:1,SINGLE:2}}}]),t}();