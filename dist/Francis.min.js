"use strict";function _classCallCheck(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,n){for(var e=0;e<n.length;e++){var a=n[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(n,e,a){return e&&t(n.prototype,e),a&&t(n,a),n}}(),Francis=function(){function t(n){_classCallCheck(this,t);var e=this;e.status=t.QUERIER_STATUS.IDLE,e.workQueue=[],e.readyTransactions=[],e.workingRequests=[],e.currentTransaction="",e.logger=n.logger||console,e.mode=n.mode||t.QUERIER_MODE.PARALLEL,e.transactions={}}return _createClass(t,[{key:"abortAll",value:function(){var n=this;for(n.status=t.QUERIER_STATUS.ABORTING;n.workingRequests.length;){var e=n.workingRequests.shift();e.xhr.abort()}}},{key:"abortTransaction",value:function(n){var e=this,a=e.transactions[n];a.status=t.QUERIER_STATUS.ABORTING;for(var r=0;r<e.workingRequests.length;r++){var o=e.workingRequests[r];o.transactionId===a.context.transactionId&&(o.xhr.abort(),e.workingRequests.splice(r,1))}}},{key:"query",value:function(t,n,e){var a=this;return a._addActionToTransaction(t,n),this}},{key:"createTransaction",value:function(t,n){var e=this;if(e.transactions.hasOwnProperty(t),e._createTransaction(t),n){var a=e.transactions[t];a.mode=n.mode||a.mode,a.transactionError=n.transactionError||a.transactionError,a.finalize=n.finalize||a.finalize}return this}},{key:"startAll",value:function(){}},{key:"startTransaction",value:function(t){}},{key:"stopAll",value:function(){}},{key:"stop",value:function(t){}},{key:"_createTransaction",value:function(n){var e=this;e.transactions[n]={name:n,context:{},actions:[],status:t.QUERIER_STATUS.IDLE,mode:t.QUERIER_MODE.SINGLE,failedCount:0,successCount:0,ended:!1,transactionError:function(){e.logger.log("oops, something went wrong :(")},finalize:function(){e.logger.log("yay, it worked :)")}},context.transactionId="something"}},{key:"_addActionToTransaction",value:function(n,e){var a=this,r=a.transactions[n],o="something";if(r.mode===t.QUERIER_MODE.SINGLE)!function(){var t=e.success;e.success=function(){successCount++,t&&"function"==typeof t&&t()};var n=e.error;e.error=function(){failedCount++,n&&"function"==typeof n&&n()}}();else{if(r.mode!==t.QUERIER_MODE.PARALLEL)return!1;!function(){var t=e.success;e.success=function(){successCount++,t&&"function"==typeof t&&t()};var n=e.error;e.error=function(){failedCount++,n&&"function"==typeof n&&n()}}()}r.actions.push({transactionName:n,transactionId:r.context.transactionId,requestId:o,ajaxObject:e})}},{key:"_performActualQuery",value:function(t){var n=this;n.currentTransaction=t.transactionName,n.workingRequests.push({transactionName:t.transactionName,transactionId:t.transactionId,requestId:t.requestId,xhr:$.ajax(t.ajaxObject)})}},{key:"_requestDone",value:function(n){var e=this;n.actions.length?n.status!==t.QUERIER_STATUS.READY&&e.status===t.QUERIER_STATUS.LOCKED||e.mode===t.QUERIER_MODE.SINGLE&&e.currentTransaction!==n.name?(e.readyTransactions.push(n.name),n.status=t.QUERIER_STATUS.READY):n.status===t.QUERIER_STATUS.LOCKED||n.status===t.QUERIER_STATUS.ABORTING||e.workQueue.push(n.actions.shift()):n.ended&&n.finalize(),e._doWork()}},{key:"_doWork",value:function(){var n=this;if(n.workQueue.length&&(n.status===t.QUERIER_STATUS.IDLE||n.status===t.QUERIER_STATUS.WORKING)){var e=n.workQueue.shift();n._performActualQuery(e)}}}],[{key:"QUERIER_STATUS",get:function(){return{IDLE:1,WORKING:2,AWAITING_RESPONSE:3,HANDLING_RESPONSE:4,ERROR:5,LOCKED:6,ABORTING:7,READY:8}}},{key:"QUERIER_MODE",get:function(){return{PARALLEL:1,SINGLE:2}}}]),t}();